<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Data Bar Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/randomcolor"></script>
    <script src="https://cdn.jsdelivr.net/npm/randomcolor@0.6.1/dist/randomColor.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        width: 1920px;
        height: 1080px;
        background-color: #00000000;
      }

      .container {
        max-width: 1550px;
        margin: 20px auto;
        padding: 20px;
        background-color: #1b070714;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .chart-container {
        position: relative;
        margin-bottom: 20px;
      }

      .chart-title {
        font-size: 24px;
        font-weight: bold;
        color: #ffffff;
        margin-bottom: 50px;
        text-align: center;
      }

      .user-data {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding-top: 20px;
        width: 100%;
        justify-content: center;
      }

      .user {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .user img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-bottom: 20px;
        border: 6px solid transparent;
      }

      .user img:hover {
        border-color: rgba(0, 0, 0, 0.1);
      }

      .user-name {
        font-size: 18px;
        font-weight: bold;
        color: #ffffff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="chart-container">
        <h2 class="chart-title">Bigg Boss Votes</h2>
        <canvas id="userDataChart" width="800" height="400"></canvas>
      </div>
    </div>
    <div id="userData" class="user-data"></div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDXSLlef9SYpaP6ZGZvieMEsdn5PvQxhJw",
        authDomain: "direct-tv-b8cbc.firebaseapp.com",
        databaseURL: "https://direct-tv-b8cbc-default-rtdb.firebaseio.com",
        projectId: "direct-tv-b8cbc",
        storageBucket: "direct-tv-b8cbc.appspot.com",
        messagingSenderId: "999287626395",
        appId: "1:999287626395:web:7ded376396f7e2d2aa443e",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      const usersRef = database.ref("users");
      usersRef.on("value", (snapshot) => {
        const userData = snapshot.val();
        const userNames = [];
        const userVotes = [];
        const userPics = [];
        const randomColors = randomColor({
          count: Object.keys(userData).length,
          luminosity: "bright",
        }); // Generate random colors

        let i = 0;
        for (let userId in userData) {
          const user = userData[userId];
          userNames.push(user.userName);
          userVotes.push(parseInt(user.userVote));
          userPics.push({ pic: user.userPic, color: randomColors[i] }); // Store both picture URL and color
          i++;
        }

        renderChart(userNames, userVotes, randomColors);
        renderUserData(userNames, userVotes, userPics);
      });

      function renderChart(userNames, userVotes, randomColors) {
        const ctx = document.getElementById("userDataChart").getContext("2d");
        const myChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: userNames,
            datasets: [
              {
                label: "Votes",
                data: userVotes,
                backgroundColor: randomColors, // Use the same random colors
                borderColor: randomColors,
                borderWidth: 1,
                borderRadius: 20, // Add rounded corners
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  display: false, // Remove grid lines for Y-axis
                },
                ticks: {
                  display: false, // Hide Y-axis ticks
                },
              },
              x: {
                display: true, // Hide X-axis
              },
            },
            plugins: {
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: function (value, context) {
                  const index = context.dataIndex;
                  const percentage =
                    (userVotes[index] /
                      userVotes.reduce((acc, curr) => acc + curr, 0)) *
                    100;
                  return percentage.toFixed(2) + "%";
                },
                color: "#333", // Color of the text
                font: {
                  size: "18", // Font size
                  weight: "bold", // Font weight
                },
              },
              legend: {
                display: false, // Hide legend
              },
            },
          },
        });
      }

      function renderUserData(userNames, userVotes, userPics) {
        const userDataContainer = document.getElementById("userData");
        userDataContainer.innerHTML = ""; // Clear previous data

        // Calculate total number of votes
        const totalVotes = userVotes.reduce((acc, curr) => acc + curr, 0);

        for (let i = 0; i < userNames.length; i++) {
          const userDiv = document.createElement("div");
          userDiv.classList.add("user");

          const imgContainer = document.createElement("div");
          const img = document.createElement("img");
          img.src = userPics[i].pic;
          img.alt = "User Image";
          img.style.backgroundColor = userPics[i].color; // Use the color generated for the user pic
          imgContainer.appendChild(img);
          userDiv.appendChild(imgContainer);

          const userName = document.createElement("p");
          userName.classList.add("user-name");
          userName.textContent = userNames[i];
          userDiv.appendChild(userName);

          const userInfo = document.createElement("p");
          const votePercentage = (userVotes[i] / totalVotes) * 100;
          userInfo.textContent = ` votes (${votePercentage.toFixed(2)}%)`;
          userDiv.appendChild(userInfo);

          userDataContainer.appendChild(userDiv);
        }
      }
    </script>
  </body>
</html>
