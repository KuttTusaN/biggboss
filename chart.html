<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Data Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/randomcolor"></script>
    <style>
      /* CSS Styles */
      body {
        width: 1920px; /* Set body width to 100% */
        height: 1080px; /* Set body height to 100% */
        margin: 0; /* Remove default margin */
        padding: 0; /* Remove default padding */
        font-family: Arial, sans-serif; /* Set font family */
        background-color: #f5f5f5; /* Set background color */
        justify-content: center;
      }

      /* Centering content */
      .container {
        max-width: 1200px; /* Set maximum width */
        margin: 0 auto; /* Center the container horizontally */
        padding: 30px; /* Add padding */
      }

      /* Styling the chart container */
      #chartContainer {
        padding: 100px;
        margin-top: 110px;
        max-width: 1200px;
        max-height: 950px; /* Adjust max width of the chart container */
        margin: 20px auto; /* Center the chart container */
      }

      /* Styling the user pictures container */
      #userPics {
        margin: 20px; /* Add top margin */
        display: flex; /* Use flexbox for layout */
        justify-content: center; /* Center items horizontally */
        flex-wrap: wrap; /* Wrap items to the next row if needed */
      }

      .user-pic {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 5px;
        border: 2px solid #fff; /* Add border with white color */
      }

      .user-pic img {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: cover;
      }

      /* Styling the total votes section */
      #totalVotes {
        font-size: 50px; /* Increase font size */
        font-weight: bold; /* Add bold font weight */
        color: #ffffff; /* Change text color */
        margin-top: 20px; /* Add top margin */
      }

      /* Media query for responsiveness */
      @media (max-width: 768px) {
        .container {
          padding: 10px; /* Adjust padding for smaller screens */
        }

        #chartContainer {
          max-width: 100%; /* Set chart container width to 100% for smaller screens */
        }
      }
    </style>
  </head>
  <body>
    <div id="chartContainer">
      <canvas id="userDataChart"></canvas>
    </div>

    <div style="display: flex; justify-content: center">
      <div id="userPics" style="display: flex; flex-wrap: wrap"></div>
    </div>
    <div style="text-align: center">
      <p>Total Votes: <span id="totalVotes"></span></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDXSLlef9SYpaP6ZGZvieMEsdn5PvQxhJw",
        authDomain: "direct-tv-b8cbc.firebaseapp.com",
        databaseURL: "https://direct-tv-b8cbc-default-rtdb.firebaseio.com",
        projectId: "direct-tv-b8cbc",
        storageBucket: "direct-tv-b8cbc.appspot.com",
        messagingSenderId: "999287626395",
        appId: "1:999287626395:web:7ded376396f7e2d2aa443e",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // Function to generate random colors
      function generateRandomColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
          colors.push(randomColor());
        }
        return colors;
      }

      // Define an array of colors for the bars using random colors
      const barColors = generateRandomColors(20); // Generate 20 random colors

      // Function to fetch and display user data
      function displayUserData() {
        const usersRef = database.ref("users");
        usersRef.on("value", (snapshot) => {
          const userData = snapshot.val();
          const userNames = [];
          const userVotes = [];
          const userPics = [];
          let totalVotes = 0;
          for (let userId in userData) {
            const user = userData[userId];
            userNames.push(user.userName);
            userVotes.push(parseInt(user.userVote));
            userPics.push({
              pic: user.userPic,
              color: barColors[userNames.length - 1],
            }); // Assign color based on bar index
            totalVotes += parseInt(user.userVote);
          }
          renderChart(userNames, userVotes, totalVotes);
          renderUserPics(userPics);
          renderTotalVotes(totalVotes);
        });
      }

      // Function to render the chart
      function renderChart(userNames, userVotes, totalVotes) {
        const percentageVotes = userVotes.map(
          (vote) => (vote / totalVotes) * 100
        );
        const ctx = document.getElementById("userDataChart").getContext("2d");
        if (window.myChart) {
          window.myChart.destroy(); // Destroy previous chart instance
        }
        window.myChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: userNames,
            datasets: [
              {
                label: "User Votes (%)",
                data: percentageVotes,
                backgroundColor: barColors.slice(0, userNames.length), // Use colors from the array dynamically
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            plugins: {
              datalabels: {
                color: "#333",
                formatter: function (value, context) {
                  // Hide percentage labels on the right side of the bars
                  return context.datasetIndex === 0
                    ? value.toFixed(2) + "%"
                    : "";
                },
                anchor: "end",
                align: "end",
                offset: -10,
              },
            },
            indexAxis: "y",
            elements: {
              bar: {
                borderWidth: 2,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return value + "%";
                  },
                },
                ticks: {
                  display: false, // Hide Y-axis ticks
                },
              },
              x: {
                grid: {
                  display: false, // Hide gridlines
                },
              },
            },
          },
        });
      }

      // Function to render user pictures
      function renderUserPics(userPics) {
        const userPicsContainer = document.getElementById("userPics");
        userPicsContainer.innerHTML = ""; // Clear previous data
        userPics.forEach((user) => {
          const userDiv = document.createElement("div");
          userDiv.classList.add("user-pic");
          userDiv.style.backgroundColor = user.color; // Set background color based on the corresponding bar color
          const img = document.createElement("img");
          img.src = user.pic;
          img.alt = "User Image";
          userDiv.appendChild(img);
          userPicsContainer.appendChild(userDiv);
        });
      }

      // Function to render total votes
      function renderTotalVotes(totalVotes) {
        const totalVotesElement = document.getElementById("totalVotes");
        totalVotesElement.textContent = totalVotes;
      }

      // Call the function to display user data when the page loads
      displayUserData();
    </script>
  </body>
</html>
